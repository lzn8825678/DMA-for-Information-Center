{% extends 'base.html' %}
{% load static %}
{% block title %}ä»»åŠ¡åˆ—è¡¨{% endblock %}

{% block content %}
<h3 class="mb-3">æˆ‘çš„ä»»åŠ¡</h3>

{% if 'tasks.add_task' in request.user.get_all_permissions %}
<a href="{% url 'add_task' %}" class="btn btn-microsoft mb-3">â• æ·»åŠ ä»»åŠ¡</a>
{% endif %}
<a href="{% url 'tasks_export' %}" class="btn btn-outline-success mb-3">ğŸ“¤ å¯¼å‡ºä»»åŠ¡æŠ¥è¡¨</a>

<table class="table table-bordered table-hover table-striped">
    <thead class="thead-light">
        <tr>
            <th>çŠ¶æ€</th>
            <th>ä»»åŠ¡</th>
            <th>é¡¹ç›®</th>
            <th>è´Ÿè´£äºº</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>å®Œæˆæ—¶é—´</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr>
            <td><span class="check-circle {% if task.is_done %}done{% endif %}" onclick="completeTask({{ task.id }}, this)"></span></td>
            <td>{{ task.title }}</td>
            <td>{{ task.project.name }}</td>
            <td>{{ task.responsible.full_name }}</td>
            <td>{{ task.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ task.completed_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6">æš‚æ— ä»»åŠ¡</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- âœ… åˆ†ç±»ä»»åŠ¡æ•°é‡å›¾ -->
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">ğŸ“Š åˆ†ç±»ä»»åŠ¡æ•°é‡ï¼ˆä»…ç»Ÿè®¡å·²å®Œæˆï¼‰</h5>
    <div style="height: 300px;">
      <canvas id="categoryChart"></canvas>
    </div>
  </div>
</div>

<!-- âœ… å¤šé¡¹ç›®è¿›åº¦å›¾ -->
<div class="card mt-5">
  <div class="card-body">
    <h5 class="card-title">ğŸ“ˆ é¡¹ç›®è¿›åº¦å æ¯”ï¼ˆæ¯ä¸ªé¡¹ç›®ï¼‰</h5>
    <div class="row">
      {% for p in project_charts %}
        <div class="col-md-4 text-center mb-4">
          <strong>{{ p.name }}</strong><br>
          <small>{{ p.percent }}% å·²å®Œæˆ</small>
          <canvas id="projectChart_{{ forloop.counter }}"></canvas>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- âœ… ä¸€å®šè¦æ”¾æœ€ä¸Šé¢ï¼ŒåŠ è½½ Chart.js -->
<script src="{% static 'js/Chart.min.js' %}"></script>

<!-- âœ… åˆ†ç±»æŸ±çŠ¶å›¾ -->
<script>
const ctx = document.getElementById('categoryChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ labels|safe }},
        datasets: [{
            label: 'ä»»åŠ¡æ•°é‡',
            data: {{ data|safe }},
            backgroundColor: '#0078D4'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                title: { display: true, text: 'æ•°é‡' }
            }
        }
    }
});
</script>

<!-- âœ… é¡¹ç›®è¿›åº¦é¥¼å›¾ -->
<script>
{% for p in project_charts %}
new Chart(document.getElementById('projectChart_{{ forloop.counter }}').getContext('2d'), {
    type: 'pie',
    data: {
        labels: ['å·²å®Œæˆ', 'æœªå®Œæˆ'],
        datasets: [{
            data: [{{ p.done }}, {{ p.undone }}],
            backgroundColor: ['#00B294', '#E5E5E5']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});
{% endfor %}
</script>

<!-- âœ… Ajax æ ‡è®°å®Œæˆ -->
<script>
function completeTask(taskId, el) {
    fetch(`/tasks/complete/${taskId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            el.classList.add('done');
        } else {
            alert(data.error || 'æ“ä½œå¤±è´¥');
        }
    });
}
</script>

<!-- âœ… æ ·å¼ -->
<style>
.check-circle {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #0078D4;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease-in-out;
}
.check-circle.done {
    background-color: #0078D4;
}
.check-circle.done::after {
    content: 'âœ”';
    color: white;
    font-size: 14px;
    position: absolute;
    top: -2px;
    left: 4px;
}
</style>
{% endblock %}
