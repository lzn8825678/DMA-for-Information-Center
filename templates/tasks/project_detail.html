{% extends 'base.html' %}
{% block title %}项目详情{% endblock %}
{% load static %}

{% block content %}
<h3 class="mb-3">项目详情：{{ project.name }}</h3>

<div class="row mb-4">
    <div class="col-md-6">
        <p>
            <strong>优先级：</strong> {{ project.priority }}<br>
            <strong>负责人：</strong>
            {% for manager in project.managers.all %}
                {{ manager.full_name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
                <span class="text-muted">无</span>
            {% endfor %}
        </p>
        <p><strong>项目进度：</strong> {{ progress_percent }}%</p>
    </div>

    <div class="col-md-6 text-center">
        <canvas id="progressChart" width="180" height="180"></canvas>
    </div>
</div>

<hr>

<h4 class="mb-3">项目任务列表</h4>
<table class="table table-bordered table-hover table-striped">
    <thead class="thead-light">
        <tr>
            <th>任务名称</th>
            <th>负责人</th>
            <th>状态</th>
            <th>创建时间</th>
            <th>完成时间</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr>
            <td>{{ task.title }}</td>
            <td>{{ task.responsible.full_name }}</td>
            <td>{% if task.is_done %}✅ 已完成{% else %}❌ 未完成{% endif %}</td>
            <td>{{ task.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ task.completed_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">暂无任务</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="mt-4">
    <a href="{% url 'project_list' %}" class="btn btn-secondary">返回项目列表</a>
</div>

<script src="{% static 'js/chart.js' %}"></script>
<script>
    var ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                data: {{ chart_data|safe }},
                backgroundColor: ['#4caf50', '#ccc']
            }]
        },
        options: {
            responsive: true,
            legend: {
                position: 'bottom'
            }
        }
    });
</script>
{% endblock %}
