{% extends 'base.html' %}
{% load static %}
{% block title %}ğŸ“ æ–‡ä»¶ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- å·¦ä¾§æ ‘å½¢ç›®å½• -->
    <div class="col-md-3">
      <h5 class="mt-3">ğŸ“‚ åˆ†ç±»ç›®å½•</h5>


      <div id="category-tree"></div>
    </div>

    <!-- å³ä¾§æ–‡ä»¶å¡ç‰‡åŒº -->
    <div class="col-md-9">
      <div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">ğŸ“ æ–‡ä»¶å¡ç‰‡å±•ç¤º</h3>
  <a href="{% url 'upload_file' %}" class="btn btn-primary">+ ä¸Šä¼ æ–‡ä»¶</a>
</div>

      <form method="get" class="mb-3">
        <input type="text" name="q" class="form-control" placeholder="æœç´¢æ–‡ä»¶æ ‡é¢˜..." value="{{ query }}">
      </form>

      {% for category, files in grouped_files.items %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>{{ category }}</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#cat_{{ forloop.counter }}">
              å±•å¼€/æ”¶èµ·
            </button>
          </div>
          <div class="collapse show" id="cat_{{ forloop.counter }}">
            <div class="card-body">
              <div class="row">
                {% for f in files %}
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                      <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ f.title }}</h6>
                        <p class="card-text small text-muted">ä¸Šä¼ è€…ï¼š{{ f.uploaded_by.full_name }}</p>
                        <p class="card-text small text-muted">æ—¶é—´ï¼š{{ f.uploaded_at|date:"Y-m-d H:i" }}</p>
                        <p class="card-text small">{{ f.description|default:"ï¼ˆæ— å¤‡æ³¨ï¼‰" }}</p>
                        <div class="mt-auto d-flex justify-content-between">
                          <a href="{{ f.file.url }}" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½</a>
                          {% if request.user == f.uploaded_by or request.user.is_superuser %}
                          <form method="post" action="{% url 'delete_file' f.id %}" onsubmit="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">åˆ é™¤</button>
                          </form>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{#    <script>#}
{#  console.log("ğŸ§ª ç±»åˆ«æ€»æ•°: ", {{ categories|length }});#}
{#</script>#}
    <script src="{% static 'js/jQuery.min.js' %}"></script>
  <script src="{% static 'js/jstree.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/style.min.css' %}">
<script>
document.addEventListener('DOMContentLoaded', function () {
  const treeData = [
    {% for cat in categories %}
      {
        "id": "{{ cat.id }}",
        "parent": "{% if cat.parent %}{{ cat.parent.id }}{% else %}#{% endif %}",
        "text": "{{ cat.name }}",
        "a_attr": { "href": "?category={{ cat.id }}" }
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  $('#category-tree').jstree({
    "core": {
      "data": treeData,
      "themes": {
        "responsive": false
      }
    },
    "plugins": ["wholerow"]  // åŠ è¿™è¡Œæ›´å¥½çœ‹ï¼Œè¡Œç‚¹å‡»ä¹Ÿå¯é€‰ä¸­
  });

  $('#category-tree').on("select_node.jstree", function (e, data) {
    window.location.href = data.node.a_attr.href;
  });
});
</script>
{% endblock %}
