{% extends 'base.html' %}
{% block title %}ä¸Šä¼ æ–‡ä»¶{% endblock %}

{% block content %}
<div class="card mt-4 shadow">
  <div class="card-body">
    <h4 class="card-title mb-4">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</h4>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="mb-3">
        <label for="title" class="form-label">åç§°ï¼ˆç”¨äºå‘½åæ‰€æœ‰æ–‡ä»¶çš„å‰ç¼€ï¼‰</label>
        <input type="text" name="title" class="form-control" placeholder="å¦‚ï¼šæµ‹è¯•èµ„æ–™ï¼Œå¯é€‰">
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">å¤‡æ³¨</label>
        <textarea name="description" class="form-control" rows="2" placeholder="å¯é€‰å¤‡æ³¨"></textarea>
      </div>

      <div class="mb-3">
  <label for="category" class="form-label">åˆ†ç±»</label>
  <select name="category" class="form-select" required>
    <option value="">-- è¯·é€‰æ‹©æ‰€å±åˆ†ç±» --</option>
    {% for cat in categories %}
      {% include "filebox/category_option.html" with cat=cat prefix="" %}
    {% endfor %}
  </select>
</div>

      <div class="mb-3">
        <label for="file" class="form-label">é€‰æ‹©æ–‡ä»¶</label>
        <input type="file" name="file" id="fileInput" class="form-control" multiple required>
        <small class="form-text text-muted">æ”¯æŒå¤šæ–‡ä»¶å’Œzipæ‰¹é‡ä¸Šä¼ </small>
      </div>

      <!-- âœ… å±•ç¤ºæ–‡ä»¶å -->
      <ul id="fileList" class="list-group mb-3 d-none"></ul>

      <!-- âœ… ä¸Šä¼ è¿›åº¦æ¡ -->
      <div class="mb-3 d-none" id="progressWrapper">
        <label class="form-label">ä¸Šä¼ è¿›åº¦</label>
        <div class="progress">
          <div id="uploadProgress" class="progress-bar progress-bar-striped" role="progressbar"
               style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            0%
          </div>
        </div>
      </div>

      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-primary">ğŸš€ ä¸Šä¼ </button>
      </div>
    </form>

    <div class="mt-3">
      <a href="{% url 'file_list' %}" class="btn btn-outline-secondary">è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const progressBar = document.getElementById('uploadProgress');
const progressWrapper = document.getElementById('progressWrapper');

// âœ… æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶å±•ç¤ºæ–‡ä»¶å
fileInput.addEventListener('change', () => {
    const files = fileInput.files;
    fileList.innerHTML = '';  // æ¸…ç©º
    if (files.length > 0) {
        fileList.classList.remove('d-none');
        for (let i = 0; i < files.length; i++) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerText = files[i].name;
            fileList.appendChild(li);
        }
    } else {
        fileList.classList.add('d-none');
    }
});

// âœ… Ajaxä¸Šä¼ 
document.getElementById('uploadForm').addEventListener('submit', function(event) {
    event.preventDefault();  // é˜»æ­¢é»˜è®¤æäº¤
    const form = event.target;
    const formData = new FormData(form);
    const xhr = new XMLHttpRequest();

    progressBar.style.width = '0%';
    progressBar.innerText = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    progressWrapper.classList.remove('d-none');  // æ˜¾ç¤ºè¿›åº¦æ¡

    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            progressBar.innerText = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
        }
    };

    xhr.onload = function() {
        if (xhr.status === 200) {
            window.location.href = "{% url 'file_list' %}";
        } else {
            alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    };

    xhr.open('POST', window.location.href, true);
    xhr.send(formData);
});
</script>
{% endblock %}
